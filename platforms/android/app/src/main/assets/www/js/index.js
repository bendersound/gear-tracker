//import { parse } from "./js/jquery.qrcode.min.js" //"querystring";

var app = {
  // Application Constructor
  initialize: function() {
    //Device listeners
    document.addEventListener('deviceready', this.onDeviceReady.bind(this), false);
    document.addEventListener('pause', this.onPause.bind(this), false);
    document.addEventListener('backbutton', this.onBackKeyDown, false);

    //Home screen listeners
    document.getElementById('cameraButton').addEventListener('click', scanQR);
    document.getElementById('openCaseList').addEventListener('click', openCaseList);

    //Case list screen listeners
    document.getElementById('submitCaseButton').addEventListener('click', openCaseFormManual);
    document.getElementById('createCaseButton').addEventListener('click', openCaseFormNew);
    document.getElementById('clearStorageButton').addEventListener('click', clearLocalStorage);
    document.getElementById('generateQRButton').addEventListener('click', generateQRManual);

    //Case form screen listeners
    document.getElementById('submitFormButton').addEventListener('click', submitForm);

    //Initializes disk storage object
    var localStorage = window.localStorage;
    var caseList;
    //var sortedCaseList;
    var caseIDText;
    var curScreen = 0;
  },

  onDeviceReady: function()
  {
    openCamera();
    caseList = openCases();

    renderCaseList(caseList);
    console.log('device ready');
  },

  onPause: function()
  {
    localStorage.setItem('numberOfCases', numberOfCases.toString());
  },

  onBackKeyDown: function(e)
  {
    if (curScreen == 0)
    {
      navigator.app.exitApp();
    }
    else if (curScreen == 1)
    {
      closeCaseList();
    }
    else if (curScreen == 2)
    {
      closeCaseForm();
    }
  }
};

// Popup dialog for testing
function popupDialog(title, message)
{
  var buttonName = 'Ok';
  navigator.notification.alert(message, alertCallback, title, buttonName);

  function alertCallback()
  {
   console.log('Alert Dismissed');
  }
}

//pause the preview so users know a code is being scanned
function scanQR()
{
  var scanCallback = function(error, content)
  {
    if(error)
    {
      popupDialog('Error', 'Scan unsuccesful')
    }
    else
    {
      {
        var idPair = content.split('.', 2);
        if (idPair[0] === 'gear_tracker') {
          var id = parseInt(idPair[1]);
          if (id < caseList.length)
          {
            openCaseForm(id);
          }
          else
          {
            popupDialog('Error', 'This QR code is for a case that does not exist');
          }
        }
        else
        {
          popupDialog('Error', 'This QR code was not generated by Gear Tracker');
        }
      }
    }
  }

  QRScanner.pausePreview(function(status)
  {
    console.log(status);
  })
  QRScanner.resumePreview(function(status)
  {
    console.log(status);
  })
  QRScanner.scan(scanCallback);
}

function generateQR(caseID)
{
  caseID = 'gear_tracker.' + caseID;
  document.getElementById('tmpQRFrame').innerHTML = '';
  if (typeof caseID !== 'undefined')
  {
    jQuery(function () {
      jQuery('#tmpQRFrame').qrcode(caseID);
    })
  }
}

function generateQRManual() {
  var input = document.getElementById('caseIDForm').value;
  generateQR(input);
}

/*
function generateQR(caseID)
{
  caseID = 'gear_tracker:' + caseID;
  document.getElementById('qrFrame').innerHTML = '';
  jQuery(function () {
    jQuery('#qrFrame').qrcode(caseID);
  })
}
*/
//Initialize and show qr code scanner
function openCamera()
{
  var prepareCallback = function(err, status)
  {
    if(error)
    {
      console.error(error._message);
    }
    else
    {
      console.log(status);
    }
  };

  QRScanner.prepare(prepareCallback);
  QRScanner.show(function(status)
  {
    console.log(status);
  });
}

//Store data on disk
function submitForm()
{
  //Store form text
  var updated = false;
  var caseNameText = document.getElementById('caseFormName').value;
  var caseInfoText = document.getElementById('caseInfoInput').value;
  
  if (typeof caseList[caseIDText] !== 'undefined') {
    if (typeof caseInfoText !== 'undefined' && caseInfoText !== caseList[caseIDText].info) {
      caseList[caseIDText].info = caseInfoText;
      updated = true;
    }

    if (typeof caseNameText !== 'undefined' && caseIDText !== caseList[caseIDText].name) {
      caseList[caseIDText].name = caseNameText;
      updated = true;
    }
  }
  else if (caseIDText === caseList.length) {
    caseList.push({ name: caseNameText, info: caseInfoText, equipment_count: 0 });
    updated = true;
  }
  else
  {
    popupDialog('Error!', 'Case could not be saved');
    return;
  }

  if (updated) renderCaseList();
  popupDialog('Success!' , 'Information updated');
}

//open form for viewing
//param caseIDText used for passing in case ID
function openCaseForm(caseID)
{
  //document.getElementById('caseForm').reset();
  if (typeof caseList[caseID] !== 'undefined') {
    document.getElementById('caseFormName').value = caseList[caseID].name;
    document.getElementById('caseInfoInput').value = caseList[caseID].info;
  }
  else if (caseID === caseList.length)
  {
    document.getElementById('caseForm').reset();
  }
  else
  {
    popupDialog('Error!', 'Cannot open case');
    return;
  }
  caseIDText = caseID;
  document.getElementById('caseFormPopup').style.display = 'block';
  curScreen = 2;
}

//get case id from field on homescreen and open for editting
function openCaseFormManual()
{
  const caseIDText = document.getElementById('caseIDForm').value;
  if (caseIDText < caseList.length) {
    openCaseForm(caseIDText);
  }
  else
  {
    popupDialog('Error!', 'Case does not exist. Create a new case.');
  }
}

function openCaseFormNew()
{
  openCaseForm(caseList.length);
}

function closeCaseForm()
{
  document.getElementById('caseFormPopup').style.display = 'none';
  curScreen = 1;
}

//clear data on disk
function clearLocalStorage()
{
  localStorage.clear();
  renderEmptyCaseList();
  caseList = [];
  popupDialog('Success', 'Local storage cleared');
}

function renderList(items, header, parent, childIndex)
{
  var tBody = document.createElement("tbody");
  var tRow = document.createElement("tr");
  var newCell;
  var i = 0;

 
  for (var headerProp in header)
  {
    newCell = document.createElement("th");
    newCell.innerHTML = header[headerProp];
    tRow.appendChild(newCell);
  }
  tBody.appendChild(tRow);
  

  for (i = 0; i < items.length; i++)
  {
    tRow = document.createElement("tr");
    //tableRow.setAttribute('data-href', 'javascript:openCaseForm(' + items[i].name + ');');

    for (var propertyValue in header)
    {
      newCell = document.createElement("td");
      newCell.innerHTML = items[i][propertyValue];
      tRow.appendChild(newCell);
    }
    tBody.appendChild(tRow);
  }
  parent.replaceChild(tBody, parent.childNodes[childIndex])
}

function renderEmptyCaseList()
{
  var cases = [];
  var header = { tmp: 'No cases here!' };
  var listParent = document.getElementById('caseList');
  renderList(cases, header, listParent, 0);
}

function renderCaseList()
{
  /*sortedCaseList = sortedCaseList.sort(function (e1, e2) {
  var name1 = e1.name.toUpperCase();
  var name2 = e2.name.toUpperCase();

  if (name1 > name2) return 1;
  if (name1 < name2) return -1;
    return 0;
  });
  */

  if (typeof caseList === 'undefined')
  {
      renderEmptyCaseList();
  }

  var header = { name: 'Name', equipment_count: 'Equipment Count' };
  var listParent = document.getElementById('caseList');

  renderList(caseList, header, listParent, 0);
}

function openTestCases0()
{
    return [];
}

function openTestCases1()
{
  var testCase1 = {name:'QSC 1', info:'1x QSC K10.2', equipment_count:1}
  var testCase2 = {name:'QSC 2', info:'1x QSC K10.2', equipment_count:1}
  var testCase3 = {name:'Cables', info:'14x GLS XLR Cable', equipment_count:14}
  var testCase4 = {name:'Megapars 1', info:'8x ADJ Megapar RGBUV', equipment_count:8}
  var testCase5 = {name:'Megapars 2', info:'8x ADJ Megapar RGBUV', equipment_count:8}

  return [testCase1, testCase2, testCase3, testCase4, testCase5];
}

function openCases()
{
  /*
   var cases = localStorage.getItem('case_list');
   */
  return openTestCases1();
}

function openCaseList()
{
  document.getElementById('leftPanel').style.display = 'block';
  curScreen = 1;
}

function closeCaseList()
{
  document.getElementById('leftPanel').style.display = 'none';
  curScreen = 0;
}

app.initialize();
